<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InovaFam3D Pro - Gest√£o Estrat√©gica</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); min-height: 100vh; padding: 20px; color: #e2e2e2; }
        .container { max-width: 1100px; margin: 0 auto; }
        .logo-container { text-align: center; margin-bottom: 15px; }
        .logo-img { max-width: 160px; height: auto; border-radius: 12px; background: white; padding: 8px; }
        
        .nav { display: flex; justify-content: center; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; }
        .nav-btn { padding: 10px 18px; border: none; border-radius: 20px; background: #0f3460; color: white; cursor: pointer; font-weight: 600; transition: 0.3s; }
        .nav-btn.active { background: #4ecca3; color: #1a1a2e; }

        .card { background: #16213e; border-radius: 20px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.05); }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
        h3 { margin-bottom: 15px; color: #4ecca3; border-bottom: 1px solid #0f3460; padding-bottom: 5px; }
        
        .input-group { margin-bottom: 12px; }
        label { display: block; font-weight: 600; margin-bottom: 5px; color: #4ecca3; font-size: 0.85em; }
        input, select { width: 100%; padding: 10px; border: 1px solid #0f3460; border-radius: 8px; background: #1a1a2e; color: white; font-size: 15px; outline: none; }
        
        .btn { width: 100%; background: #4ecca3; color: #1a1a2e; border: none; padding: 12px; border-radius: 10px; font-weight: bold; cursor: pointer; transition: 0.3s; margin-top: 5px; }
        .btn:hover { background: #45b393; }

        /* Tabela de Pre√ßos */
        .price-table { width: 100%; border-collapse: collapse; margin-top: 15px; background: rgba(255,255,255,0.02); border-radius: 10px; overflow: hidden; }
        .price-table th, .price-table td { padding: 12px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .price-table th { background: #0f3460; color: #4ecca3; font-size: 0.9em; }
        .price-table tr:hover { background: rgba(78, 204, 163, 0.1); }
        .btn-sel { background: #4ecca3; color: #1a1a2e; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 0.8em; font-weight: bold; }

        #login-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 80vh; }
        .login-card { background: white; padding: 35px; border-radius: 20px; width: 100%; max-width: 380px; color: #333; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="login-screen">
    <div class="logo-container"><img src="logo.png.jfif" class="logo-img" onerror="this.style.display='none'"></div>
    <div class="login-card">
        <h2 style="text-align:center; margin-bottom:20px;">InovaFam3D üîê</h2>
        <input type="password" id="pass-input" placeholder="Senha da Empresa" style="width:100%; padding:12px; margin-bottom:15px; border:1px solid #ddd; border-radius:10px;">
        <button class="btn" onclick="checkLogin()">ACESSAR SISTEMA</button>
    </div>
</div>

<div id="main-content" class="container hidden">
    <div class="header" style="text-align:center; margin-bottom:20px;">
        <h1 style="color:#4ecca3">InovaFam3D</h1>
        <p style="font-size: 0.8em; color: #888;">Gest√£o Estrat√©gica de Precifica√ß√£o</p>
    </div>

    <div class="nav">
        <button class="nav-btn active" onclick="showTab('calc')">Calculadora</button>
        <button class="nav-btn" onclick="showTab('produtos')">Produtos</button>
        <button class="nav-btn" onclick="showTab('config')">Configura√ß√µes</button>
        <button class="nav-btn" onclick="showTab('history')">Hist√≥rico</button>
    </div>

    <div id="calc" class="card">
        <h3>üßÆ Calculadora de Margens</h3>
        <div class="grid">
            <div class="input-group">
                <label>Selecionar Produto:</label>
                <select id="sel_prod" onchange="calcularTabela()"></select>
            </div>
            <div class="input-group">
                <label>Plataforma de Venda:</label>
                <select id="sel_plat" onchange="calcularTabela()">
                    <option value="pix">PIX / Direta (0%)</option>
                    <option value="elo7">Elo7 (12% + 1,50)</option>
                    <option value="ml">Mercado Livre (16% + 5,00)</option>
                    <option value="shopee">Shopee (20%)</option>
                </select>
            </div>
        </div>

        <div id="res_tabela_container" class="hidden">
            <table class="price-table">
                <thead>
                    <tr>
                        <th>Margem</th>
                        <th>Pre√ßo Sugerido</th>
                        <th>Lucro L√≠quido</th>
                        <th>A√ß√£o</th>
                    </tr>
                </thead>
                <tbody id="tabela_corpo"></tbody>
            </table>
            <p style="margin-top: 15px; font-size: 0.8em; color: #888; text-align: center;">* O custo base j√° inclui filamento, energia, embalagem e falhas.</p>
        </div>
    </div>

    <div id="produtos" class="card hidden">
        <h3>üì¶ Cadastro de Produtos</h3>
        <div class="grid">
            <div class="input-group"><label>Nome:</label><input type="text" id="p_nome"></div>
            <div class="input-group">
                <label>Filamento:</label>
                <select id="p_tipo">
                    <option value="pla">PLA</option>
                    <option value="petg">PETG</option>
                    <option value="abs">ABS</option>
                    <option value="tpu">TPU</option>
                    <option value="asa">ASA</option>
                </select>
            </div>
            <div class="input-group"><label>Peso Total (g):</label><input type="number" id="p_peso"></div>
            <div class="input-group"><label>Tempo (h):</label><input type="number" id="p_tempo" step="0.1"></div>
        </div>
        <button class="btn" onclick="addProduto()">SALVAR PRODUTO</button>
        <div id="lista_p" style="margin-top:20px"></div>
    </div>

    <div id="config" class="card hidden">
        <div class="grid">
            <div>
                <h3>üí∞ Filamento (R$/kg)</h3>
                <div class="input-group"><label>PLA:</label><input type="number" id="c_pla"></div>
                <div class="input-group"><label>PETG:</label><input type="number" id="c_petg"></div>
                <div class="input-group"><label>ABS:</label><input type="number" id="c_abs"></div>
                <div class="input-group"><label>TPU:</label><input type="number" id="c_tpu"></div>
                <div class="input-group"><label>ASA:</label><input type="number" id="c_asa"></div>
            </div>
            <div>
                <h3>‚ö° Custos Operacionais</h3>
                <div class="input-group"><label>Energia (R$/kWh):</label><input type="number" id="c_luz" step="0.01"></div>
                <div class="input-group"><label>Consumo Impressora (W):</label><input type="number" id="c_watts"></div>
                <div class="input-group"><label>Embalagem (R$):</label><input type="number" id="c_emb"></div>
                <div class="input-group"><label>Taxa de Falha (%):</label><input type="number" id="c_falha"></div>
            </div>
        </div>
        <button class="btn" onclick="saveConfigs()">ATUALIZAR CONFIGURA√á√ïES</button>
    </div>

    <div id="history" class="card hidden">
        <h3>üìã Hist√≥rico de Vendas</h3>
        <div id="lista_vendas"></div>
    </div>
</div>

<script>
    const GOOGLE_URL = "https://script.google.com/macros/s/AKfycbycyHpnL4YYf_kyuvdne82MqWPFt_LL19bS40H6ba3yvs6nhVWBmL1mBZ_e_qOGJWcV/exec";
    
    let config = JSON.parse(localStorage.getItem('inova_cfg')) || {
        pla:95, petg:90, abs:80, tpu:150, asa:120,
        luz:0.95, watts:250, emb:3.5, falha:5, pass:"15@0117Inova"
    };

    let produtos = JSON.parse(localStorage.getItem('inova_prods')) || [];
    let vendas = JSON.parse(localStorage.getItem('inova_vendas')) || [];

    function checkLogin() {
        if(document.getElementById('pass-input').value === config.pass) {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('main-content').classList.remove('hidden');
            init();
        } else { alert("Senha incorreta!"); }
    }

    function init() {
        renderProdsDropdown();
        renderProdsLista();
        loadConfigInputs();
    }

    function saveConfigs() {
        config.pla = parseFloat(document.getElementById('c_pla').value);
        config.petg = parseFloat(document.getElementById('c_petg').value);
        config.abs = parseFloat(document.getElementById('c_abs').value);
        config.tpu = parseFloat(document.getElementById('c_tpu').value);
        config.asa = parseFloat(document.getElementById('c_asa').value);
        config.luz = parseFloat(document.getElementById('c_luz').value);
        config.watts = parseFloat(document.getElementById('c_watts').value);
        config.emb = parseFloat(document.getElementById('c_emb').value);
        config.falha = parseFloat(document.getElementById('c_falha').value);
        localStorage.setItem('inova_cfg', JSON.stringify(config));
        alert("Configura√ß√µes Salvas!");
        calcularTabela();
    }

    function loadConfigInputs() {
        document.getElementById('c_pla').value = config.pla;
        document.getElementById('c_petg').value = config.petg;
        document.getElementById('c_abs').value = config.abs;
        document.getElementById('c_tpu').value = config.tpu;
        document.getElementById('c_asa').value = config.asa;
        document.getElementById('c_luz').value = config.luz;
        document.getElementById('c_watts').value = config.watts;
        document.getElementById('c_emb').value = config.emb;
        document.getElementById('c_falha').value = config.falha;
    }

    // C√ÅLCULO DA TABELA DE PRE√áOS
    function calcularTabela() {
        const pId = document.getElementById('sel_prod').value;
        if(!pId) return;
        const p = produtos.find(prod => prod.id == pId);
        const plat = document.getElementById('sel_plat').value;
        
        // 1. Custo do Filamento
        const custoFil = (p.peso / 1000) * config[p.tipo];
        // 2. Custo de Energia (Watts -> kWh)
        const custoLuz = (config.watts / 1000) * p.tempo * config.luz;
        // 3. Custo Base (Filamento + Luz + Embalagem + Falha)
        const custoTotalBase = (custoFil + custoLuz + config.emb) * (1 + (config.falha/100));

        const margens = [20, 50, 70, 100, 150, 200];
        const corpo = document.getElementById('tabela_corpo');
        corpo.innerHTML = "";
        document.getElementById('res_tabela_container').classList.remove('hidden');

        margens.forEach(m => {
            let precoComMargem = custoTotalBase * (1 + (m / 100));
            
            // Aplicar Taxas de Plataforma
            let precoFinal = 0;
            let taxaPlat = 0;
            if(plat === 'pix') { precoFinal = precoComMargem; }
            else if(plat === 'elo7') { precoFinal = (precoComMargem + 1.5) / 0.88; taxaPlat = (precoFinal * 0.12) + 1.5; }
            else if(plat === 'ml') { precoFinal = (precoComMargem + 5) / 0.84; taxaPlat = (precoFinal * 0.16) + 5; }
            else if(plat === 'shopee') { precoFinal = precoComMargem / 0.80; taxaPlat = precoFinal * 0.20; }

            const lucroLiq = precoFinal - custoTotalBase - taxaPlat;

            corpo.innerHTML += `
                <tr>
                    <td>${m}%</td>
                    <td><b>R$ ${precoFinal.toFixed(2)}</b></td>
                    <td style="color: #4ecca3">R$ ${lucroLiq.toFixed(2)}</td>
                    <td><button class="btn-sel" onclick="registrarVenda('${p.nome}', ${precoFinal.toFixed(2)}, ${lucroLiq.toFixed(2)}, '${plat}', ${m})">VENDER</button></td>
                </tr>
            `;
        });
    }

    function registrarVenda(nome, preco, lucro, plat, margem) {
        const venda = {
            data: new Date().toLocaleDateString(),
            nome: nome,
            preco: preco,
            lucro: lucro,
            plataforma: plat,
            margem: margem + "%"
        };
        vendas.unshift(venda);
        localStorage.setItem('inova_vendas', JSON.stringify(vendas));
        
        // Envio para Planilha
        fetch(GOOGLE_URL, {method:'POST', mode:'no-cors', body:JSON.stringify(venda)});
        
        alert("Venda registrada na Planilha!");
        showTab('history');
    }

    // GEST√ÉO DE PRODUTOS
    function addProduto() {
        const p = {
            id: Date.now(),
            nome: document.getElementById('p_nome').value,
            tipo: document.getElementById('p_tipo').value,
            peso: parseFloat(document.getElementById('p_peso').value) || 0,
            tempo: parseFloat(document.getElementById('p_tempo').value) || 0
        };
        if(!p.nome) return alert("Preencha o nome!");
        produtos.push(p);
        localStorage.setItem('inova_prods', JSON.stringify(produtos));
        init();
        alert("Produto Salvo!");
    }

    function renderProdsDropdown() {
        const sel = document.getElementById('sel_prod');
        sel.innerHTML = '<option value="">-- Escolha um produto --</option>' + 
            produtos.map(p => `<option value="${p.id}">${p.nome} (${p.tipo.toUpperCase()})</option>`).join('');
    }

    function renderProdsLista() {
        document.getElementById('lista_p').innerHTML = produtos.map(p => `
            <div class="history-item" style="display:flex; justify-content:space-between; padding:10px; background:rgba(255,255,255,0.05); margin-bottom:5px; border-radius:10px;">
                <span>${p.nome} (${p.tipo.toUpperCase()})</span>
                <button onclick="removerProd(${p.id})" style="background:#e94560; border:none; color:white; padding:5px 10px; border-radius:5px; cursor:pointer;">Remover</button>
            </div>
        `).join('');
    }

    function removerProd(id) {
        produtos = produtos.filter(p => p.id !== id);
        localStorage.setItem('inova_prods', JSON.stringify(produtos));
        init();
    }

    function renderHistory() {
        document.getElementById('lista_vendas').innerHTML = vendas.map(v => `
            <div class="history-item" style="padding:15px; border-radius:10px; background:rgba(255,255,255,0.03); margin-bottom:10px; border:1px solid rgba(255,255,255,0.05);">
                <div style="display:flex; justify-content:space-between;">
                    <b>${v.nome}</b>
                    <span style="color:#4ecca3">R$ ${v.preco}</span>
                </div>
                <small>${v.data} | Margem: ${v.margem} | Plat: ${v.plataforma.toUpperCase()}</small>
            </div>
        `).join('');
    }

    function showTab(tab) {
        document.querySelectorAll('.card').forEach(c => c.classList.add('hidden'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(tab).classList.remove('hidden');
        event.target.classList.add('active');
        if(tab === 'history') renderHistory();
    }

    function logout() { location.reload(); }
</script>

</body>
</html>
