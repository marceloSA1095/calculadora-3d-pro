<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InovaFam3D - BI & Gestão</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-main: #0d1117; --bg-card: #161b22; --border: #30363d;
            --primary: #58a6ff; --success: #238636; --danger: #da3633;
            --text-p: #c9d1d9; --text-s: #8b949e; --gold: #d299ff;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: var(--bg-main); color: var(--text-p); }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }

        /* Login */
        #login-screen { position: fixed; inset: 0; background: var(--bg-main); display: flex; align-items: center; justify-content: center; z-index: 10000; }
        .login-card { background: var(--bg-card); padding: 40px; border-radius: 20px; border: 1px solid var(--border); width: 380px; text-align: center; }

        /* KPI */
        .kpi-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .kpi-card { background: var(--bg-card); padding: 20px; border-radius: 12px; border: 1px solid var(--border); border-left: 4px solid var(--primary); }
        .kpi-card span { font-size: 0.7em; color: var(--text-s); text-transform: uppercase; font-weight: 800; }
        .kpi-card h2 { font-size: 1.6em; margin-top: 5px; }

        /* Nav */
        .nav { display: flex; gap: 10px; margin-bottom: 25px; background: var(--bg-card); padding: 8px; border-radius: 12px; border: 1px solid var(--border); overflow-x: auto; }
        .nav-btn { padding: 10px 20px; border: none; background: transparent; color: var(--text-s); cursor: pointer; border-radius: 8px; font-weight: 600; white-space: nowrap; transition: 0.3s; }
        .nav-btn.active { background: var(--primary); color: white; }

        /* Main */
        .grid-layout { display: grid; grid-template-columns: 1fr 380px; gap: 20px; }
        .card { background: var(--bg-card); padding: 25px; border-radius: 16px; border: 1px solid var(--border); margin-bottom: 20px; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        label { display: block; font-size: 0.75em; color: var(--text-s); margin-bottom: 6px; font-weight: 600; }
        input, select { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; background: #0d1117; color: white; font-size: 0.95em; outline: none; }
        
        /* Tables */
        .matrix-table { width: 100%; border-collapse: collapse; }
        .matrix-table th { text-align: left; padding: 12px; font-size: 0.75em; color: var(--text-s); border-bottom: 1px solid var(--border); }
        .matrix-table td { padding: 12px; border-bottom: 1px solid #21262d; font-size: 0.9em; }
        .btn-del { color: var(--danger); background: none; border: none; cursor: pointer; padding: 5px; }
        .btn-del:hover { color: #ff7b72; }

        .hidden { display: none !important; }
        .btn-main { background: var(--primary); color: #000; border: none; padding: 16px; border-radius: 10px; font-weight: bold; cursor: pointer; width: 100%; }

        @media (max-width: 900px) { .grid-layout { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div id="login-screen">
    <div class="login-card">
        <h1>InovaFam3D</h1>
        <input type="password" id="pass-input" placeholder="Senha Corporativa">
        <button class="btn-main" onclick="checkAuth()">ENTRAR NO SISTEMA</button>
    </div>
</div>

<div id="app" class="container hidden">
    <div class="kpi-row">
        <div class="kpi-card"><span>Faturamento</span><h2 id="kpi-fat">R$ 0,00</h2></div>
        <div class="kpi-card" style="border-color: var(--success)"><span>Lucro</span><h2 id="kpi-luc">R$ 0,00</h2></div>
        <div class="kpi-card" style="border-color: var(--gold)"><span>Vendas</span><h2 id="kpi-vol">0</h2></div>
        <div class="kpi-card" style="border-color: var(--danger)"><span>Marketing</span><h2 id="kpi-ads">R$ 0,00</h2></div>
    </div>

    <nav class="nav">
        <button class="nav-btn active" onclick="tab('dash')">Dashboard</button>
        <button class="nav-btn" onclick="tab('calc')">Calculadora</button>
        <button class="nav-btn" onclick="tab('items')">Catálogo</button>
        <button class="nav-btn" onclick="tab('report')">Vendas/Estorno</button>
        <button class="nav-btn" onclick="tab('config')">Config</button>
    </nav>

    <div id="tab-dash" class="tab-content">
        <div class="grid-layout">
            <div class="card">
                <h3>Resumo do Mês</h3>
                <select id="view-month" onchange="refreshBI()" style="margin-bottom:20px; width:200px;"></select>
                <canvas id="mainChart" height="150"></canvas>
            </div>
            <div class="card">
                <h3>Últimos Lançamentos</h3>
                <div id="recent-list"></div>
            </div>
        </div>
    </div>

    <div id="tab-calc" class="tab-content hidden">
        <div class="grid-layout">
            <div class="card">
                <h3>Configuração de Orçamento</h3>
                <div class="input-box" style="margin-bottom:15px">
                    <label>Modo</label>
                    <select id="calc_origin" onchange="updateCalcUI()">
                        <option value="cat">Item do Catálogo</option>
                        <option value="free">Manual</option>
                    </select>
                </div>
                <div id="box-cat" class="input-box"><label>Produto</label><select id="calc_sel_item" onchange="runEngine()"></select></div>
                <div id="box-free" class="hidden form-grid">
                    <div><label>Peso (g)</label><input type="number" id="f_peso" oninput="runEngine()"></div>
                    <div><label>Material</label><select id="f_tipo" onchange="runEngine()"><option value="pla">PLA</option><option value="petg">PETG</option></select></div>
                </div>
                <div class="form-grid" style="margin-top:15px">
                    <div><label>Plataforma</label><select id="calc_plat" onchange="runEngine()"><option value="pix">Venda Direta</option><option value="elo7">Elo7</option><option value="ml">Mercado Livre</option><option value="shopee">Shopee</option></select></div>
                    <div><label>ADS</label><select id="calc_ads" onchange="runEngine()"><option value="0">Sem ADS</option><option value="google">Google</option><option value="social">Social</option></select></div>
                </div>
            </div>
            <div class="card">
                <h3>Matriz de Preço</h3>
                <table class="matrix-table">
                    <thead><tr><th>Margem</th><th>Venda</th><th>Lucro</th><th></th></tr></thead>
                    <tbody id="matrix-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="tab-items" class="tab-content hidden">
        <div class="card">
            <h3>Novo Item</h3>
            <div class="form-grid">
                <input type="text" id="p_nome" placeholder="Nome do Produto">
                <select id="p_tipo"><option value="pla">PLA</option><option value="petg">PETG</option></select>
                <input type="number" id="p_peso" placeholder="Peso (g)">
                <input type="number" id="p_tempo" placeholder="Tempo (h)" step="0.1">
            </div>
            <button class="btn-main" onclick="saveToCatalog()" style="margin-top:15px">SALVAR</button>
        </div>
        <div id="catalog-list"></div>
    </div>

    <div id="tab-report" class="tab-content hidden">
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h3>Relatório Detalhado</h3>
                <button onclick="exportCSV()" class="nav-btn" style="border:1px solid var(--border)">Exportar CSV</button>
            </div>
            <div style="overflow-x:
