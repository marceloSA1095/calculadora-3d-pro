<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>InovaFam3D | Cloud OS</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Paleta Oficial InovaFam3D */
        :root {
            --brand-blue: #004B79; --brand-lime: #96C83C; --brand-lime-hover: #7ea832;
            --bg-base: #070e14; --bg-surface: #0e1721; --bg-elevated: #162230;
            --separator: #1f3042; --accent: var(--brand-lime); --accent-dim: rgba(150, 200, 60, 0.15);
            --success: #96C83C; --warning: #ffd60a; --danger: #ff453a;
            --text-primary: #ffffff; --text-secondary: #8ba0b5;
            --radius-lg: 20px; --radius-md: 12px; --radius-sm: 8px;
            --font-stack: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: var(--font-stack); -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg-base); color: var(--text-primary); -webkit-font-smoothing: antialiased; display: flex; height: 100vh; overflow: hidden; }

        h1 { font-size: 34px; font-weight: 800; letter-spacing: -0.5px; }
        h2 { font-size: 22px; font-weight: 600; letter-spacing: -0.3px; }
        h3 { font-size: 17px; font-weight: 600; }
        p, span { font-size: 15px; }
        .caption { font-size: 12px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; }

        .logo-text-inova { color: #58a6ff; }
        .logo-text-fam { color: var(--brand-lime); }
        .logo-text-3d { color: var(--text-primary); }

        #login-view { position: fixed; inset: 0; background: radial-gradient(circle at center, var(--bg-surface) 0%, var(--bg-base) 100%); display: flex; align-items: center; justify-content: center; z-index: 9999; }
        .login-box { width: 100%; max-width: 380px; padding: 45px 30px; text-align: center; background: rgba(14, 23, 33, 0.8); backdrop-filter: blur(15px); border-radius: 24px; border: 1px solid var(--separator); box-shadow: 0 20px 40px rgba(0,0,0,0.5); }
        
        #app-layout { display: flex; width: 100%; height: 100%; }
        
        .sidebar { width: 260px; background-color: var(--bg-surface); border-right: 1px solid var(--separator); padding: 30px 20px; display: flex; flex-direction: column; gap: 10px; }
        .sidebar-header { margin-bottom: 30px; padding-left: 10px; text-align: center; }
        .nav-item { display: flex; align-items: center; gap: 15px; padding: 12px 15px; border-radius: var(--radius-md); color: var(--text-secondary); cursor: pointer; transition: 0.2s; font-weight: 500; }
        .nav-item:hover { background-color: var(--bg-elevated); color: var(--text-primary); }
        .nav-item.active { background-color: var(--accent-dim); color: var(--accent); font-weight: 600; }
        .nav-item i { font-size: 18px; width: 20px; text-align: center; }

        .main-content { flex: 1; overflow-y: auto; padding: 40px; background-color: var(--bg-base); position: relative; }
        .view-section { display: none; animation: fadeIn 0.3s ease; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .card { background-color: var(--bg-surface); border-radius: var(--radius-lg); padding: 24px; border: 1px solid var(--separator); margin-bottom: 24px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
        .grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 24px; }
        
        .input-group { margin-bottom: 16px; }
        label { display: block; font-size: 13px; color: var(--text-secondary); margin-bottom: 8px; font-weight: 500; }
        input, select { width: 100%; background-color: var(--bg-elevated); border: 1px solid transparent; color: var(--text-primary); padding: 14px 16px; border-radius: var(--radius-md); font-size: 15px; transition: 0.2s; outline: none; }
        input:focus, select:focus { border-color: var(--brand-lime); background-color: var(--bg-surface); box-shadow: 0 0 0 2px var(--accent-dim); }
        
        button { cursor: pointer; border: none; outline: none; transition: 0.2s; font-weight: 600; }
        .btn-primary { background-color: var(--accent); color: #000000; padding: 14px 24px; border-radius: var(--radius-md); width: 100%; font-size: 15px; font-weight: 700; }
        .btn-primary:hover { background-color: var(--brand-lime-hover); }
        .btn-primary:active { transform: scale(0.98); }
        .btn-secondary { background-color: var(--bg-elevated); color: var(--text-primary); padding: 10px 16px; border-radius: var(--radius-md); }

        .segmented-control { display: flex; background-color: var(--bg-elevated); padding: 4px; border-radius: var(--radius-md); margin-bottom: 24px; }
        .segmented-control button { flex: 1; padding: 10px; background: transparent; color: var(--text-secondary); border-radius: var(--radius-sm); font-size: 14px; }
        .segmented-control button.active { background-color: var(--separator); color: var(--text-primary); box-shadow: 0 2px 8px rgba(0,0,0,0.2); border-bottom: 2px solid var(--brand-lime); }

        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 16px 0; border-bottom: 1px solid var(--separator); }
        .list-item:last-child { border-bottom: none; }
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .badge.pendente { background: rgba(255,214,10,0.15); color: var(--warning); }
        .badge.concluido { background: rgba(150, 200, 60, 0.15); color: var(--brand-lime); }

        #cloud-status { position: fixed; bottom: 20px; right: 20px; background: var(--bg-elevated); padding: 10px 20px; border-radius: 20px; font-size: 12px; color: var(--text-secondary); display: flex; align-items: center; gap: 8px; z-index: 10000; border: 1px solid var(--separator); box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--warning); box-shadow: 0 0 5px var(--warning); }
        .status-dot.online { background: var(--brand-lime); box-shadow: 0 0 5px var(--brand-lime); }

        @media (max-width: 768px) {
            #app-layout { flex-direction: column; }
            .sidebar { width: 100%; border-right: none; border-bottom: 1px solid var(--separator); padding: 15px; flex-direction: row; justify-content: space-around; overflow-x: auto; }
            .sidebar-header { display: none; }
            .nav-item { flex-direction: column; gap: 5px; padding: 10px; font-size: 11px; }
            .nav-item span { display: block; }
            .main-content { padding: 20px; }
            .grid-2 { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<div id="cloud-status">
    <div id="status-indicator" class="status-dot"></div>
    <span id="status-text">Conectando Firebase...</span>
</div>

<div id="login-view">
    <div class="login-box">
        <h1 style="margin-bottom: 5px;">
            <span class="logo-text-inova">Inova</span><span class="logo-text-fam">Fam</span><span class="logo-text-3d">3D</span>
        </h1>
        <p class="caption" style="margin-bottom: 30px;">Criando o futuro juntos</p>
        
        <div class="segmented-control" id="user-switcher">
            <button class="active" onclick="App.setUser('Marcelo')">Marcelo</button>
            <button onclick="App.setUser('Fernanda')">Fernanda</button>
        </div>
        
        <div class="input-group">
            <input type="password" id="auth-pass" placeholder="Senha de Acesso" onkeypress="if(event.key === 'Enter') App.login()">
        </div>
        <button class="btn-primary" onclick="App.login()">Entrar no Sistema</button>
    </div>
</div>

<div id="app-layout" style="display: none;">
    <nav class="sidebar">
        <div class="sidebar-header">
            <h2 style="font-size: 24px;">
                <span class="logo-text-inova">Inova</span><span class="logo-text-fam">Fam</span><span class="logo-text-3d">3D</span>
            </h2>
            <p class="caption" id="user-display" style="margin-top: 5px;">Usuário</p>
        </div>
        <div class="nav-item active" onclick="App.navigate('dash', this)"><i class="fas fa-chart-pie"></i><span>Visão Geral</span></div>
        <div class="nav-item" onclick="App.navigate('orders', this)"><i class="fas fa-layer-group"></i><span>Fila de Pedidos</span></div>
        <div class="nav-item" onclick="App.navigate('calc', this)"><i class="fas fa-calculator"></i><span>Precificação</span></div>
        <div class="nav-item" onclick="App.navigate('catalog', this)"><i class="fas fa-box-open"></i><span>Catálogo Cloud</span></div>
        <div class="nav-item" onclick="App.navigate('settings', this)"><i class="fas fa-sliders-h"></i><span>Parâmetros</span></div>
        <div style="flex: 1;"></div>
        <div class="nav-item" onclick="App.logout()" style="color: var(--danger);"><i class="fas fa-sign-out-alt"></i><span>Sair da Nuvem</span></div>
    </nav>

    <main class="main-content">
        <section id="view-dash" class="view-section active">
            <div style="display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 30px;">
                <div>
                    <h1>Visão Geral</h1>
                    <p class="caption" id="dash-date"></p>
                </div>
                <select id="dash-month-filter" onchange="App.Views.Dashboard.render()" style="width: auto; padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 600; background: var(--bg-surface);"></select>
            </div>
            <div class="grid-3">
                <div class="card"><p class="caption">Receita Bruta</p><h2 id="kpi-revenue" style="font-size: 32px; margin-top: 5px;">R$ 0,00</h2></div>
                <div class="card"><p class="caption">Lucro Líquido</p><h2 id="kpi-profit" style="font-size: 32px; margin-top: 5px; color: var(--brand-lime);">R$ 0,00</h2></div>
                <div class="card"><p class="caption">Volume (Mês)</p><h2 id="kpi-margin" style="font-size: 32px; margin-top: 5px; color: var(--text-primary);">0</h2></div>
            </div>
            <div class="card" style="padding: 30px;"><h3 style="margin-bottom: 20px;">Fluxo de Receita Diário</h3><div style="height: 250px;"><canvas id="revenueChart"></canvas></div></div>
        </section>

        <section id="view-orders" class="view-section">
            <div style="margin-bottom: 30px;"><h1>Fila de Produção</h1><p class="caption">Sincronizado em tempo real</p></div>
            <div class="card"><div id="orders-list"></div></div>
        </section>

        <section id="view-calc" class="view-section">
            <div style="margin-bottom: 30px;"><h1>Motor de Precificação</h1><p class="caption">Cálculos baseados nos parâmetros da nuvem</p></div>
            <div class="grid-2">
                <div class="card">
                    <h3>Parâmetros da Venda</h3>
                    <div class="input-group" style="margin-top: 20px;">
                        <label>1. Selecione a Peça</label>
                        <select id="calc-model" onchange="App.Views.Calc.run()"></select>
                    </div>
                    <div class="input-group">
                        <label>2. Canal de Escoamento</label>
                        <select id="calc-channel" onchange="App.Views.Calc.run()">
                            <option value="pix">PIX (0%)</option>
                            <option value="elo7">Elo7 (12% + R$ 1.50)</option>
                            <option value="ml">Mercado Livre (16% + R$ 5.00)</option>
                            <option value="shopee">Shopee (20%)</option>
                        </select>
                    </div>
                    <div style="border-top: 1px solid var(--separator); padding-top: 20px; margin-top: 10px;">
                        <label>3. Simulação de Logística (Opcional)</label>
                        <div style="display: flex; gap: 10px;"><input type="text" id="calc-cep" placeholder="CEP Destino" maxlength="8"><button class="btn-secondary" onclick="App.Views.Calc.fetchFrete()">Calcular</button></div>
                        <div id="frete-result" style="margin-top: 15px; padding: 15px; background: var(--bg-elevated); border-radius: var(--radius-sm); font-size: 13px; display: none;"></div>
                    </div>
                </div>
                <div class="card"><h3 style="margin-bottom: 20px;">Análise de Margem</h3><div id="pricing-matrix"><p style="color: var(--text-secondary); font-size: 14px; text-align: center; padding: 40px 0;">Selecione uma peça.</p></div></div>
            </div>
        </section>

        <section id="view-catalog" class="view-section">
            <div style="margin-bottom: 30px;"><h1>Catálogo de Modelos</h1><p class="caption">Banco de dados centralizado</p></div>
            <div class="card">
                <h3>Cadastrar Novo Modelo</h3>
                <div class="grid-3" style="margin-top: 20px;">
                    <div class="input-group"><label>Nome do Projeto</label><input type="text" id="cat-name"></div>
                    <div class="input-group"><label>Material Primário</label><select id="cat-mat"><option value="pla">PLA</option><option value="petg">PETG</option></select></div>
                    <div class="input-group"><label>Peso (gramas)</label><input type="number" id="cat-weight" title="Peso físico real do objeto"></div>
                    <div class="input-group"><label>Tempo de Máquina (horas)</label><input type="number" id="cat-time" step="0.5"></div>
                    <div class="input-group"><label>Tempo Humano</label><select id="cat-labor"><option value="0.25">15 min</option><option value="0.5" selected>30 min</option><option value="1">1 hora</option><option value="2">2 horas</option></select></div>
                    <div class="input-group"><label>Dimensões na Caixa (A x L x P em cm)</label><div style="display: flex; gap: 5px;"><input type="number" id="cat-h" placeholder="A"><input type="number" id="cat-w" placeholder="L"><input type="number" id="cat-d" placeholder="P"></div></div>
                </div>
                <button class="btn-primary" style="width: auto; margin-top: 10px;" onclick="App.Views.Catalog.save()">Salvar na Nuvem</button>
            </div>
            <div class="card"><h3 style="margin-bottom: 15px;">Itens Sincronizados</h3><div id="catalog-list"></div></div>
        </section>

        <section id="view-settings" class="view-section">
            <div style="margin-bottom: 30px;"><h1>Parâmetros da Operação</h1><p class="caption">Variáveis globais de custo</p></div>
            <div class="grid-2">
                <div class="card">
                    <h3>Custos Base</h3>
                    <div class="grid-2" style="margin-top: 20px;">
                        <div class="input-group"><label>Custo PLA (R$/kg)</label><input type="number" id="set-pla"></div>
                        <div class="input-group"><label>Custo PETG (R$/kg)</label><input type="number" id="set-petg"></div>
                        <div class="input-group"><label>Energia (R$/kWh)</label><input type="number" id="set-power"></div>
                        <div class="input-group"><label>Depreciação Máquina (R$/h)</label><input type="number" id="set-dep"></div>
                        <div class="input-group"><label>Hora Humana (R$/h)</label><input type="number" id="set-labor"></div>
                        <div class="input-group"><label>Margem Falha (%)</label><input type="number" id="set-fail"></div>
                    </div>
                </div>
                <div class="card">
                    <h3>Logística & Sistema</h3>
                    <div class="input-group" style="margin-top: 20px;"><label>CEP Base</label><input type="text" id="set-cep" maxlength="8"></div>
                    <div class="input-group"><label>Custo Fixo Embalagem (R$)</label><input type="number" id="set-box"></div>
                    <div style="margin-top: 40px; border-top: 1px solid var(--separator); padding-top: 20px;">
                        <button class="btn-primary" onclick="App.Views.Settings.save()">Atualizar Configurações</button>
                    </div>
                </div>
            </div>
        </section>
    </main>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import { getFirestore, collection, doc, setDoc, addDoc, deleteDoc, updateDoc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDqWO24ihthEEJORidmpVIaVSfd-pKz-0A",
        authDomain: "inovafam3d.firebaseapp.com",
        projectId: "inovafam3d",
        storageBucket: "inovafam3d.firebasestorage.app",
        messagingSenderId: "867870082459",
        appId: "1:867870082459:web:0223439b0d5068dadf8d3e",
        measurementId: "G-BXYXX0CBTX"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const Store = {
        auth: { marcelo: "15@0117Inova", fernanda: "15@0117Inova" },
        currentUser: 'Marcelo',
        settings: { pla: 110, petg: 100, power: 0.95, dep: 1.5, labor: 35, fail: 10, box: 5, cep: "092109210", watts: 280 },
        catalog: [],
        orders: [],

        initCloudSync() {
            const settingsRef = doc(db, "system", "settings");
            onSnapshot(settingsRef, (docSnap) => {
                if (docSnap.exists()) {
                    this.settings = { ...this.settings, ...docSnap.data() };
                    if (document.getElementById('view-settings').classList.contains('active')) App.Views.Settings.load();
                } else { setDoc(settingsRef, this.settings); }
            });

            const catalogRef = collection(db, "catalog");
            onSnapshot(catalogRef, (snapshot) => {
                this.catalog = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                App.Views.Catalog.render();
                App.Views.Calc.init();
            });

            const ordersRef = query(collection(db, "orders"), orderBy("date", "desc"));
            onSnapshot(ordersRef, (snapshot) => {
                this.orders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                App.Views.Orders.render();
                App.Views.Dashboard.render();
            });

            document.getElementById('status-indicator').classList.add('online');
            document.getElementById('status-text').innerText = "Nuvem Conectada e Sincronizada";
        }
    };

    const App = {
        chartInstance: null,
        init() { document.getElementById('dash-date').innerText = new Date().toLocaleDateString('pt-BR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }); this.populateMonthFilter(); },
        setUser(name) { Store.currentUser = name; const btns = document.querySelectorAll('#user-switcher button'); btns[0].classList.toggle('active', name === 'Marcelo'); btns[1].classList.toggle('active', name === 'Fernanda'); },
        login() { const pass = document.getElementById('auth-pass').value; const correctPass = Store.currentUser === 'Marcelo' ? Store.auth.marcelo : Store.auth.fernanda; if (pass === correctPass) { document.getElementById('login-view').style.display = 'none'; document.getElementById('app-layout').style.display = 'flex'; document.getElementById('user-display').innerText = Store.currentUser; Store.initCloudSync(); setTimeout(() => { this.Views.Settings.load(); this.Views.Catalog.render(); this.Views.Dashboard.render(); this.Views.Orders.render(); }, 500); } else { alert("Senha incorreta."); document.getElementById('auth-pass').value = ''; } },
        logout() { location.reload(); },
        navigate(viewId, el) { document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active')); document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active')); document.getElementById('view-' + viewId).classList.add('active'); el.classList.add('active'); if(viewId === 'calc') this.Views.Calc.init(); if(viewId === 'orders') this.Views.Orders.render(); },
        populateMonthFilter() { const months = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"]; const sel = document.getElementById('dash-month-filter'); const currMonth = new Date().getMonth(); sel.innerHTML = months.map((m, i) => `<option value="${i}" ${i === currMonth ? 'selected' : ''}>${m}</option>`).join(''); },

        Views: {
            Dashboard: {
                render() {
                    const targetMonth = parseInt(document.getElementById('dash-month-filter').value);
                    const completed = Store.orders.filter(o => o.status === 'done' && new Date(o.date).getMonth() === targetMonth);
                    const revenue = completed.reduce((sum, o) => sum + o.price, 0);
                    const profit = completed.reduce((sum, o) => sum + o.profit, 0);

                    document.getElementById('kpi-revenue').innerText = revenue.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                    document.getElementById('kpi-profit').innerText = profit.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                    document.getElementById('kpi-margin').innerText = completed.length;

                    this.renderChart(completed);
                },
                renderChart(data) {
                    const ctx = document.getElementById('revenueChart').getContext('2d');
                    if (App.chartInstance) App.chartInstance.destroy();

                    const daily = {};
                    data.forEach(o => { const day = new Date(o.date).getDate(); daily[day] = (daily[day] || 0) + o.price; });
                    const labels = Object.keys(daily).sort((a,b) => a-b);
                    const values = labels.map(l => daily[l]);

                    App.chartInstance = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: labels.map(l => `Dia ${l}`),
                            datasets: [{ label: 'Receita', data: values, backgroundColor: '#96C83C', borderRadius: 4 }]
                        },
                        options: {
                            responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } },
                            scales: { y: { grid: { color: '#1f3042' }, ticks: { color: '#8ba0b5' }, beginAtZero: true }, x: { grid: { display: false }, ticks: { color: '#8ba0b5' } } }
                        }
                    });
                }
            },

            Orders: {
                render() {
                    const container = document.getElementById('orders-list');
                    if (Store.orders.length === 0) { container.innerHTML = `<p style="color: var(--text-secondary); text-align: center; padding: 20px;">Nenhum pedido na base de dados.</p>`; return; }
                    const sorted = [...Store.orders].sort((a, b) => { if(a.status === 'pending' && b.status === 'done') return -1; if(a.status === 'done' && b.status === 'pending') return 1; return 0; });
                    container.innerHTML = sorted.map(o => ` <div class="list-item" style="flex-direction: column; align-items: flex-start; gap: 10px;"> <div style="display: flex; justify-content: space-between; width: 100%;"> <div> <h3 style="margin-bottom: 4px;">${o.itemName}</h3> <p class="caption">${o.channel.toUpperCase()} • ${new Date(o.date).toLocaleDateString('pt-BR')}</p> </div> <div style="text-align: right;"> <h3 style="color: var(--brand-lime);">${o.price.toLocaleString('pt-BR', {style: 'currency', currency:'BRL'})}</h3> <span class="badge ${o.status === 'pending' ? 'pendente' : 'concluido'}"> ${o.status === 'pending' ? 'NA FILA' : 'CONCLUÍDO'} </span> </div> </div> ${o.status === 'pending' ? `<button class="btn-secondary" style="width: 100%; margin-top: 10px; color: var(--brand-lime);" onclick="App.Views.Orders.markDone('${o.id}')"><i class="fas fa-check" style="margin-right: 8px;"></i>Marcar como Concluído</button>` : `<button style="background:none; border:none; color: var(--danger); font-size: 13px; cursor: pointer; margin-top: 5px;" onclick="App.Views.Orders.delete('${o.id}')">Excluir da Nuvem</button>` } </div> `).join('');
                },
                async add(item, price, profit, channel) { try { await addDoc(collection(db, "orders"), { itemName: item.name, price: price, profit: profit, channel: channel, status: 'pending', date: Date.now(), user: Store.currentUser }); alert("Pedido enviado para a nuvem!"); } catch (e) { alert("Falha na comunicação com o banco de dados."); } },
                async markDone(id) { try { await updateDoc(doc(db, "orders", id), { status: 'done' }); } catch (e) { console.error(e); } },
                async delete(id) { if(confirm("Remover permanentemente?")) { try { await deleteDoc(doc(db, "orders", id)); } catch (e) { console.error(e); } } }
            },

            Calc: {
                init() { const sel = document.getElementById('calc-model'); sel.innerHTML = '<option value="">-- Selecione do Catálogo --</option>' + Store.catalog.map(i => `<option value="${i.id}">${i.name}</option>`).join(''); document.getElementById('pricing-matrix').innerHTML = ''; document.getElementById('frete-result').style.display = 'none'; },
                run() {
                    const itemId = document.getElementById('calc-model').value; const channel = document.getElementById('calc-channel').value; if(!itemId) return;
                    const item = Store.catalog.find(i => i.id === itemId); const s = Store.settings;
                    const matCost = (item.weight / 1000) * s[item.mat]; const riskCost = matCost * (s.fail / 100); const powerCost = (s.watts / 1000) * item.time * s.power; const depCost = item.time * s.dep; const laborCost = item.labor * s.labor;
                    const baseCost = matCost + riskCost + powerCost + depCost + laborCost + s.box;
                    const margins = [30, 50, 80, 100, 150];
                    let html = ` <div style="background: var(--bg-elevated); padding: 15px; border-radius: var(--radius-sm); margin-bottom: 20px;"> <p class="caption">Custo Real de Fabricação</p> <h2 style="color: var(--danger); margin-top: 5px;">R$ ${baseCost.toFixed(2)}</h2> </div> `;
                    html += margins.map(m => {
                        let price = baseCost * (1 + (m/100)); if(channel === 'elo7') price = (price + 1.5) / 0.88; if(channel === 'ml') price = (price + 5) / 0.84; if(channel === 'shopee') price = price / 0.80;
                        const fees = (channel === 'pix' ? 0 : (channel === 'elo7' ? (price*0.12)+1.5 : (channel === 'ml' ? (price*0.16)+5 : price*0.20))); const profit = price - fees - baseCost;
                        const itemJson = JSON.stringify(item).replace(/"/g, '&quot;');
                        return ` <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid var(--separator);"> <div> <span class="badge" style="background: var(--bg-elevated); color: var(--text-primary); margin-bottom: 5px; display: inline-block;">Meta: ${m}%</span> <h3>R$ ${price.toFixed(2)}</h3> <p style="font-size: 12px; color: var(--brand-lime);">Lucro: R$ ${profit.toFixed(2)}</p> </div> <button class="btn-primary" style="width: auto; padding: 10px 20px; color: #000;" onclick="App.Views.Orders.add(${itemJson}, ${price}, ${profit}, '${channel}')">Gerar Pedido</button> </div> `;
                    }).join('');
                    document.getElementById('pricing-matrix').innerHTML = html;
                },
                async fetchFrete() {
                    const cep = document.getElementById('calc-cep').value.replace(/\D/g, '');
                    const resEl = document.getElementById('frete-result');
                    const itemId = document.getElementById('calc-model').value;
                    
                    if(cep.length !== 8) { alert("CEP Inválido"); return; }
                    if(!itemId) { alert("Selecione o produto."); return; }

                    const item = Store.catalog.find(i => i.id === itemId);
                    resEl.style.display = 'block';
                    resEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Consultando Correios...';

                    try {
                        const req = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
                        const data = await req.json();
                        if(data.erro) throw new Error();

                        const ufOrigem = Store.settings.cep.substring(0,2);
                        const ufDestino = cep.substring(0,2);
                        let base = ufOrigem === ufDestino ? 18.90 : 36.50;
                        
                        // LÓGICA DE FRETE REAL (Físico vs Cubagem)
                        const pesoFisico = item.weight / 1000; // Convertendo para KG
                        const pesoCubico = (item.dim.h * item.dim.w * item.dim.d) / 6000;
                        const pesoTarifado = Math.max(pesoFisico, pesoCubico);
                        
                        const motivoTarifa = pesoCubico > pesoFisico ? "Volume (Cubagem)" : "Peso Físico";

                        if(pesoTarifado > 1) base += (Math.ceil(pesoTarifado - 1) * 6.50); // Adicional por KG extra

                        resEl.innerHTML = `
                            <b>Destino:</b> ${data.localidade} - ${data.uf}<br>
                            <div style="display: flex; gap: 15px; margin: 8px 0; color: var(--text-secondary); font-size: 12px;">
                                <span><i class="fas fa-weight-hanging"></i> Físico: ${pesoFisico.toFixed(2)}kg</span>
                                <span><i class="fas fa-box"></i> Cúbico: ${pesoCubico.toFixed(2)}kg</span>
                            </div>
                            <span style="font-size: 12px;">Tarifado por: <b style="color: var(--text-primary);">${motivoTarifa}</b></span><br>
                            <span style="color: var(--brand-lime); font-weight: 600; display: block; margin-top: 10px; font-size: 15px;">PAC Est.: R$ ${base.toFixed(2)}</span>
                        `;
                    } catch(e) {
                        resEl.innerHTML = '<span style="color: var(--danger);">Falha ao consultar CEP.</span>';
                    }
                }
            },

            Catalog: {
                render() { const container = document.getElementById('catalog-list'); container.innerHTML = Store.catalog.map(i => ` <div class="list-item"> <div> <h3 style="margin-bottom: 4px;">${i.name}</h3> <p class="caption">${i.mat.toUpperCase()} • ${i.weight}g • ${i.time}h print</p> </div> <button style="background:none; border:none; color: var(--danger); cursor: pointer; padding: 10px;" onclick="App.Views.Catalog.delete('${i.id}')"><i class="fas fa-trash"></i></button> </div> `).join(''); },
                async save() { const name = document.getElementById('cat-name').value; const mat = document.getElementById('cat-mat').value; const weight = parseFloat(document.getElementById('cat-weight').value); const time = parseFloat(document.getElementById('cat-time').value); const labor = parseFloat(document.getElementById('cat-labor').value); const h = parseFloat(document.getElementById('cat-h').value || 10); const w = parseFloat(document.getElementById('cat-w').value || 10); const d = parseFloat(document.getElementById('cat-d').value || 10); if(!name || !weight || !time) return alert("Preencha Nome, Peso e Tempo."); try { await addDoc(collection(db, "catalog"), { name, mat, weight, time, labor, dim: {h,w,d} }); ['cat-name', 'cat-weight', 'cat-time'].forEach(id => document.getElementById(id).value = ''); alert("Item salvo na nuvem!"); } catch (e) { alert("Erro ao gravar."); } },
                async delete(id) { if(confirm("Apagar da nuvem?")) { try { await deleteDoc(doc(db, "catalog", id)); } catch (e) { console.error(e); } } }
            },

            Settings: {
                load() { const s = Store.settings; document.getElementById('set-pla').value = s.pla; document.getElementById('set-petg').value = s.petg; document.getElementById('set-power').value = s.power; document.getElementById('set-dep').value = s.dep; document.getElementById('set-labor').value = s.labor; document.getElementById('set-fail').value = s.fail; document.getElementById('set-cep').value = s.cep; document.getElementById('set-box').value = s.box; },
                async save() { const s = { pla: parseFloat(document.getElementById('set-pla').value), petg: parseFloat(document.getElementById('set-petg').value), power: parseFloat(document.getElementById('set-power').value), dep: parseFloat(document.getElementById('set-dep').value), labor: parseFloat(document.getElementById('set-labor').value), fail: parseFloat(document.getElementById('set-fail').value), cep: document.getElementById('set-cep').value, box: parseFloat(document.getElementById('set-box').value), watts: 280 }; try { await setDoc(doc(db, "system", "settings"), s); alert("Configurações atualizadas."); } catch (e) { alert("Erro ao salvar."); } }
            }
        }
    };

    window.App = App;
    window.onload = () => App.init();
</script>
</body>
</html>
